name: "03 - PR Reviewer Agent"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  issues: read
  contents: write # TODO: change to read

concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  reviewer-debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug (what reviewer would see)
        run: |
          echo "PR = #${{ github.event.pull_request.number }}"
          echo "Base = ${{ github.event.pull_request.base.ref }}"
          echo "Head = ${{ github.event.pull_request.head.ref }}"
          echo "SHA  = ${{ github.event.pull_request.head.sha }}"
          echo
          echo "Workspace listing:"
          ls -la "${{ github.workspace }}"
          echo
          echo "Example diff (base...HEAD):"
          git fetch origin "${{ github.event.pull_request.base.ref }}"
          git diff "origin/${{ github.event.pull_request.base.ref }}...HEAD" --name-only | head -n 50
      
      - name: Docker mount sanity check
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            alpine:3.20 \
            sh -lc 'echo "inside container:"; pwd; ls -la; test -d .git && echo ".git exists"'
      
      - name: Git push smoke test (temp)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b smoke/test-push-${{ github.run_id }}
          echo "$(date)" > .smoke_push.txt
          git add .smoke_push.txt
          git commit -m "smoke: test push"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
          git push -u origin HEAD

      
      # - name: Pull agent image
      #   run: docker pull ghcr.io/<OWNER>/<AGENT_IMAGE>:v0.1.0
      #
      # - name: Run Reviewer Agent (comment/review/summary)
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
      #     REPO: ${{ github.repository }}
      #     PR_NUMBER: ${{ github.event.pull_request.number }}
      #   run: |
      #     docker run --rm \
      #       -e GH_TOKEN \
      #       -e LLM_API_KEY \
      #       -e REPO \
      #       -e PR_NUMBER \
      #       -v "${{ github.workspace }}:/work" \
      #       -w /work \
      #       ghcr.io/<OWNER>/<AGENT_IMAGE>:v0.1.0 \
      #       agent review \
      #         --repo "$REPO" \
      #         --pr "$PR_NUMBER"
