<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование локации</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/forms.css" rel="stylesheet">
    <link href="/static/css/tags.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .photo-container {
            position: relative;
            margin-bottom: 1rem;
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 8px;
            background: white;
            display: flex;
            flex-direction: column;
        }
        .photo-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .photo-container.sortable-ghost {
            opacity: 0.4;
        }
        .photo-container.sortable-chosen {
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            transform: scale(1.02);
        }
        .photo-preview-wrapper {
            position: relative;
            cursor: move;
        }
        .photo-preview {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px 8px 0 0;
            pointer-events: none;
        }
        .photo-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .photo-container:hover .photo-actions {
            opacity: 1;
        }
        .photo-actions button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .photo-actions button:hover {
            transform: scale(1.1);
        }
        .photo-caption {
            margin-top: 0.5rem;
            width: 200px;
            cursor: text;
            border-top: 1px solid #dee2e6;
            padding-top: 0.5rem;
        }
        .photo-caption:focus {
            cursor: text;
            pointer-events: auto;
        }
        #photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .drag-handle {
            cursor: move;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Редактирование локации</h1>
            <a href="/api/v1/web/locations" class="btn btn-secondary">Назад к списку</a>
        </div>

        <form id="location-form" class="mb-4">
            <div class="mb-3">
                <label for="name" class="form-label">Название*</label>
                <input type="text" class="form-control" id="name" name="name" required>
                <div class="invalid-feedback">
                    Пожалуйста, введите название локации
                </div>
            </div>

            <div class="mb-3">
                <label for="address" class="form-label">Адрес*</label>
                <input type="text" class="form-control" id="address" name="address" required>
                <div class="invalid-feedback">
                    Пожалуйста, введите адрес
                </div>
            </div>

            <div class="mb-3">
                <label for="maps_url" class="form-label">Ссылка на Яндекс Карты*</label>
                <input type="url" class="form-control" id="maps_url" name="maps_url" required
                       placeholder="https://yandex.ru/maps/-/CCUxxxxx">
                <div class="invalid-feedback">
                    Пожалуйста, введите корректную ссылку на Яндекс Карты
                </div>
            </div>

            <div class="mb-3">
                <label for="categories" class="form-label">Категории*</label>
                <div id="categories-list" class="tags-list"></div>
                <input type="text" class="form-control" id="categories-input"
                       placeholder="Введите категорию и нажмите Enter">
                <input type="hidden" id="categories-hidden" name="categories" required>
                <div class="invalid-feedback">
                    Добавьте хотя бы одну категорию
                </div>
            </div>

            <div class="mb-3">
                <label for="tags" class="form-label">Теги</label>
                <div id="tags-list" class="tags-list"></div>
                <input type="text" class="form-control" id="tags-input"
                       placeholder="Введите тег и нажмите Enter">
                <input type="hidden" id="tags-hidden" name="tags">
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Описание*</label>
                <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                <div class="invalid-feedback">
                    Пожалуйста, добавьте описание
                </div>
            </div>

            <div class="mb-3">
                <label for="instagram_url" class="form-label">Ссылка на Instagram</label>
                <input type="url" class="form-control" id="instagram_url" name="instagram_url"
                       placeholder="https://www.instagram.com/example/">
                <div class="invalid-feedback">
                    Пожалуйста, введите корректную ссылку на Instagram
                </div>
            </div>

            <div class="mb-3">
                <label for="working_hours" class="form-label">Часы работы</label>
                <input type="text" class="form-control" id="working_hours" name="working_hours"
                       placeholder="Пн-Пт: 9:00-18:00">
            </div>

            <div class="mb-3">
                <label for="rating" class="form-label">Рейтинг</label>
                <input type="number" class="form-control" id="rating" name="rating"
                       min="0" max="5" step="0.1">
                <div class="invalid-feedback">
                    Рейтинг должен быть от 0 до 5
                </div>
            </div>
        </form>

        <div class="mb-4">
            <h5>Фотографии</h5>
            <div class="mb-3">
                <input type="file" class="form-control" id="photo-upload" accept="image/*" multiple>
            </div>
            <div id="photos-grid">
                <!-- Фотографии будут добавлены здесь через JavaScript -->
            </div>
        </div>

        <div class="d-flex gap-2 mb-4">
            <button type="submit" form="location-form" class="btn btn-primary">Сохранить изменения</button>
            <button type="button" class="btn btn-secondary" id="cancel-button">Отмена</button>
        </div>
    </div>

    <template id="photo-template">
        <div class="photo-container" draggable="true">
            <div class="photo-preview-wrapper">
                <img class="photo-preview">
                <div class="photo-actions">
                    <button class="delete-photo" title="Удалить">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <input type="text" class="form-control photo-caption" placeholder="Подпись к фото">
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="/static/js/tags-manager.js"></script>
    <script>
        let locationId;
        let photos = [];
        let originalData = null;
        let newPhotos = [];
        let deletedPhotos = new Set();
        let modifiedCaptions = new Map();
        let photoOrder = [];

        document.addEventListener('DOMContentLoaded', () => {
            locationId = window.location.pathname.split('/').slice(-2)[0];

            // Инициализируем менеджеры тегов
            const categoriesManager = new TagsManager(
                'categories-input',
                'categories-list',
                'categories-hidden',
                true
            );

            const tagsManager = new TagsManager(
                'tags-input',
                'tags-list',
                'tags-hidden',
                false
            );

            // Настраиваем компоненты
            setupPhotoUpload();
            setupFormSubmit();
            setupPhotosGrid();
            setupCancelButton();

            // Загружаем данные
            loadLocation();
        });

        function setupCancelButton() {
            document.getElementById('cancel-button').addEventListener('click', () => {
                if (confirm('Вы уверены, что хотите отменить все изменения?')) {
                    resetForm();
                }
            });
        }

        function resetForm() {
            // Сбрасываем все локальные изменения
            newPhotos = [];
            deletedPhotos.clear();
            modifiedCaptions.clear();
            
            if (originalData) {
                // Восстанавливаем данные формы
                document.getElementById('name').value = originalData.name || '';
                document.getElementById('address').value = originalData.address || '';
                document.getElementById('maps_url').value = originalData.maps_url || '';
                document.getElementById('instagram_url').value = originalData.instagram_url || '';
                document.getElementById('working_hours').value = originalData.working_hours || '';
                document.getElementById('description').value = originalData.description || '';
                document.getElementById('rating').value = originalData.rating || '';
                
                // Восстанавливаем категории и теги
                document.getElementById('categories-hidden').value = originalData.categories ? originalData.categories.join(',') : '';
                document.getElementById('tags-hidden').value = originalData.tags ? originalData.tags.join(',') : '';
                
                // Перезагружаем менеджеры тегов
                new TagsManager('categories-input', 'categories-list', 'categories-hidden', true);
                new TagsManager('tags-input', 'tags-list', 'tags-hidden', false);
                
                // Восстанавливаем фотографии
                photos = [...originalData.photos];
                renderPhotos();
            }

            // Сбрасываем состояние валидации формы
            document.getElementById('location-form').classList.remove('was-validated');
        }

        async function loadLocation() {
            try {
                const response = await fetch(`/api/v1/locations/${locationId}`);
                if (!response.ok) throw new Error('Ошибка при загрузке локации');
                const location = await response.json();
                
                // Сохраняем оригинальные данные
                originalData = JSON.parse(JSON.stringify(location));
                
                // Заполняем форму
                document.getElementById('name').value = location.name || '';
                document.getElementById('address').value = location.address || '';
                document.getElementById('maps_url').value = location.maps_url || '';
                document.getElementById('instagram_url').value = location.instagram_url || '';
                document.getElementById('working_hours').value = location.working_hours || '';
                document.getElementById('description').value = location.description || '';
                document.getElementById('rating').value = location.rating || '';

                // Заполняем категории и теги
                document.getElementById('categories-hidden').value = location.categories ? location.categories.join(',') : '';
                document.getElementById('tags-hidden').value = location.tags ? location.tags.join(',') : '';

                // Перезагружаем менеджеры тегов
                new TagsManager('categories-input', 'categories-list', 'categories-hidden', true);
                new TagsManager('tags-input', 'tags-list', 'tags-hidden', false);

                // Загружаем фотографии
                photos = location.photos || [];
                photoOrder = photos.map(photo => photo.id);
                renderPhotos();
            } catch (error) {
                console.error('Ошибка при загрузке локации:', error);
                alert('Не удалось загрузить данные локации');
            }
        }

        function setupPhotoUpload() {
            const input = document.getElementById('photo-upload');
            input.addEventListener('change', () => {
                const files = Array.from(input.files);
                newPhotos.push(...files);
                
                // Добавляем временные превью
                files.forEach(file => {
                    const tempId = 'temp_' + Math.random().toString(36).substr(2, 9);
                    photos.push({
                        id: tempId,
                        photo_url: URL.createObjectURL(file),
                        caption: '',
                        isTemp: true
                    });
                });
                
                renderPhotos();
                input.value = ''; // Очищаем input
            });
        }

        function setupFormSubmit() {
            const form = document.getElementById('location-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (!form.checkValidity()) {
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }

                try {
                    // Сначала обновляем основные данные локации
                    const formData = new FormData(form);
                    const locationData = {};

                    for (const [key, value] of formData.entries()) {
                        if (value.trim()) {
                            locationData[key] = value.trim();
                        }
                    }

                    if (locationData.categories) {
                        locationData.categories = locationData.categories.split(',').map(c => c.trim());
                    }
                    if (locationData.tags) {
                        locationData.tags = locationData.tags.split(',').map(t => t.trim());
                    }

                    // Очистка пустых значений
                    for (const key in locationData) {
                        if (!locationData[key] ||
                            (Array.isArray(locationData[key]) && locationData[key].length === 0)) {
                            delete locationData[key];
                        }
                    }

                    // Обновляем основные данные
                    const updateResponse = await fetch(`/api/v1/locations/${locationId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(locationData)
                    });

                    if (!updateResponse.ok) {
                        const error = await updateResponse.json();
                        throw new Error(error.detail || 'Ошибка при обновлении локации');
                    }

                    // Загружаем новые фотографии
                    if (newPhotos.length > 0) {
                        const photoFormData = new FormData();
                        newPhotos.forEach(file => {
                            photoFormData.append('photos', file);
                        });

                        const uploadResponse = await fetch(`/api/v1/locations/${locationId}/photos`, {
                            method: 'POST',
                            body: photoFormData
                        });

                        if (!uploadResponse.ok) {
                            throw new Error('Ошибка при загрузке фотографий');
                        }
                    }

                    // Удаляем фотографии
                    for (const photoId of deletedPhotos) {
                        if (!photoId.startsWith('temp_')) {
                            await fetch(`/api/v1/locations/${locationId}/photos/${photoId}`, {
                                method: 'DELETE'
                            });
                        }
                    }

                    // Обновляем подписи к фотографиям
                    for (const [photoId, caption] of modifiedCaptions.entries()) {
                        if (!photoId.startsWith('temp_')) {
                            await fetch(`/api/v1/locations/${locationId}/photos/${photoId}/caption`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ caption })
                            });
                        }
                    }

                    // Обновляем порядок фотографий
                    const finalPhotoOrder = photoOrder.filter(id => !id.startsWith('temp_'));
                    if (finalPhotoOrder.length > 0) {
                        await fetch(`/api/v1/locations/${locationId}/photos/reorder`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ photo_order: finalPhotoOrder })
                        });
                    }

                    window.location.href = '/api/v1/web/locations';
                } catch (error) {
                    console.error('Ошибка при сохранении:', error);
                    alert(error.message);
                }
            });
        }

        function setupPhotosGrid() {
            const grid = document.getElementById('photos-grid');
            new Sortable(grid, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                handle: '.photo-preview-wrapper',
                onEnd: () => {
                    photoOrder = Array.from(grid.children).map(container => container.dataset.photoId);
                }
            });
        }

        function renderPhotos() {
            const grid = document.getElementById('photos-grid');
            const template = document.getElementById('photo-template');
            grid.innerHTML = '';

            photos.forEach(photo => {
                if (deletedPhotos.has(photo.id)) return;

                const clone = template.content.cloneNode(true);
                const container = clone.querySelector('.photo-container');
                const preview = clone.querySelector('.photo-preview');
                const caption = clone.querySelector('.photo-caption');
                const deleteBtn = clone.querySelector('.delete-photo');

                container.dataset.photoId = photo.id;
                preview.src = photo.photo_url;
                preview.alt = photo.caption || 'Фото локации';
                caption.value = modifiedCaptions.get(photo.id) || photo.caption || '';

                caption.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        caption.blur();
                    }
                });

                caption.addEventListener('blur', () => {
                    const newCaption = caption.value.trim();
                    if (newCaption !== (photo.caption || '')) {
                        modifiedCaptions.set(photo.id, newCaption);
                    }
                });

                deleteBtn.addEventListener('click', () => {
                    if (confirm('Вы уверены, что хотите удалить это фото?')) {
                        deletedPhotos.add(photo.id);
                        if (photo.isTemp) {
                            const index = newPhotos.findIndex(f => f.name === photo.originalName);
                            if (index !== -1) {
                                newPhotos.splice(index, 1);
                            }
                        }
                        renderPhotos();
                    }
                });

                grid.appendChild(clone);
            });
        }
    </script>
</body>
</html>
