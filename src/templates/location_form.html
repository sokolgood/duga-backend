<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if location %}Редактировать{% else %}Создать{% endif %} локацию</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/forms.css" rel="stylesheet">
    <link href="/static/css/tags.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>{% if location %}Редактировать{% else %}Создать{% endif %} локацию</h1>
        <form id="locationForm" class="needs-validation" novalidate>
            <div class="mb-3">
                <label for="name" class="form-label">Название*</label>
                <input type="text" class="form-control" id="name" name="name" required
                       value="{{ location.name if location else '' }}">
                <div class="invalid-feedback">
                    Пожалуйста, введите название локации
                </div>
            </div>

            <div class="mb-3">
                <label for="address" class="form-label">Адрес*</label>
                <input type="text" class="form-control" id="address" name="address" required
                       value="{{ location.address if location else '' }}">
                <div class="invalid-feedback">
                    Пожалуйста, введите адрес
                </div>
            </div>

            <div class="mb-3">
                <label for="maps_url" class="form-label">Ссылка на Яндекс Карты*</label>
                <input type="url" class="form-control" id="maps_url" name="maps_url" required
                       placeholder="https://yandex.ru/maps/-/CCUxxxxx"
                       value="{{ location.maps_url if location else '' }}">
                <div class="invalid-feedback">
                    Пожалуйста, введите корректную ссылку на Яндекс Карты
                </div>
            </div>

            <div class="mb-3">
                <label for="categories" class="form-label">Категории*</label>
                <div id="categories-list" class="tags-list"></div>
                <input type="text" class="form-control" id="categories-input"
                       placeholder="Введите категорию и нажмите Enter">
                <input type="hidden" id="categories-hidden" name="categories" required
                       value="{{ ','.join(location.categories) if location and location.categories else '' }}">
                <div class="invalid-feedback">
                    Добавьте хотя бы одну категорию
                </div>
            </div>

            <div class="mb-3">
                <label for="tags" class="form-label">Теги</label>
                <div id="tags-list" class="tags-list"></div>
                <input type="text" class="form-control" id="tags-input"
                       placeholder="Введите тег и нажмите Enter">
                <input type="hidden" id="tags-hidden" name="tags"
                       value="{{ ','.join(location.tags) if location and location.tags else '' }}">
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Описание*</label>
                <textarea class="form-control" id="description" name="description" rows="3" required>{{ location.description if location else '' }}</textarea>
                <div class="invalid-feedback">
                    Пожалуйста, добавьте описание
                </div>
            </div>

            <div class="mb-3">
                <label for="instagram_url" class="form-label">Ссылка на Instagram</label>
                <input type="url" class="form-control" id="instagram_url" name="instagram_url"
                       placeholder="https://www.instagram.com/example/"
                       value="{{ location.instagram_url if location else '' }}">
                <div class="invalid-feedback">
                    Пожалуйста, введите корректную ссылку на Instagram
                </div>
            </div>

            <div class="mb-3">
                <label for="working_hours" class="form-label">Часы работы</label>
                <input type="text" class="form-control" id="working_hours" name="working_hours"
                       placeholder="Пн-Пт: 9:00-18:00"
                       value="{{ location.working_hours if location else '' }}">
            </div>

            <div class="mb-3">
                <label for="rating" class="form-label">Рейтинг</label>
                <input type="number" class="form-control" id="rating" name="rating"
                       min="0" max="5" step="0.1"
                       value="{{ location.rating if location else '' }}">
                <div class="invalid-feedback">
                    Рейтинг должен быть от 0 до 5
                </div>
            </div>

            <button type="submit" class="btn btn-primary">
                {% if location %}Сохранить{% else %}Создать{% endif %}
            </button>
            <a href="/api/v1/web/locations" class="btn btn-secondary">Отмена</a>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="/static/js/tags-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация менеджеров тегов
            const categoriesManager = new TagsManager(
                'categories-input',
                'categories-list',
                'categories-hidden',
                true
            );

            const tagsManager = new TagsManager(
                'tags-input',
                'tags-list',
                'tags-hidden',
                false
            );

            // Валидация формы
            const form = document.getElementById('locationForm');
            form.addEventListener('submit', async function(event) {
                event.preventDefault();

                if (!form.checkValidity()) {
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }

                const formData = new FormData(form);
                const locationData = {};

                for (const [key, value] of formData.entries()) {
                    if (value.trim()) {
                        locationData[key] = value.trim();
                    }
                }

                // Преобразование строк в массивы
                if (locationData.categories) {
                    locationData.categories = locationData.categories.split(',').map(c => c.trim());
                }
                if (locationData.tags) {
                    locationData.tags = locationData.tags.split(',').map(t => t.trim());
                }

                // Очистка пустых значений
                for (const key in locationData) {
                    if (!locationData[key] ||
                        (Array.isArray(locationData[key]) && locationData[key].length === 0)) {
                        delete locationData[key];
                    }
                }

                console.log('Отправляемые данные:', locationData);

                try {
                    const response = await fetch('/api/v1/locations{% if location %}/{{ location.id }}{% endif %}', {
                        method: '{% if location %}PATCH{% else %}POST{% endif %}',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(locationData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Ошибка:', errorData);
                        throw new Error(`Ошибка при ${location ? 'обновлении' : 'создании'} локации: ${errorData.detail || response.statusText}`);
                    }

                    const result = await response.json();
                    window.location.href = '/api/v1/web/locations';
                } catch (error) {
                    alert(error.message);
                }
            });
        });
    </script>
</body>
</html>
